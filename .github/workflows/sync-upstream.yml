name: Sync with Upstream

on:
  # Run every Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: 'Upstream branch to sync from'
        required: false
        default: 'master'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/xremap/xremap.git || true
          git remote set-url upstream https://github.com/xremap/xremap.git

      - name: Fetch upstream changes
        run: |
          git fetch upstream ${{ github.event.inputs.upstream_branch || 'master' }}

      - name: Check for new commits
        id: check
        run: |
          # Get the merge base (common ancestor)
          MERGE_BASE=$(git merge-base HEAD upstream/${{ github.event.inputs.upstream_branch || 'master' }})

          # Check if there are new commits in upstream
          UPSTREAM_HEAD=$(git rev-parse upstream/${{ github.event.inputs.upstream_branch || 'master' }})

          if [ "$MERGE_BASE" = "$UPSTREAM_HEAD" ]; then
            echo "No new commits in upstream"
            echo "has_new_commits=false" >> $GITHUB_OUTPUT
          else
            echo "New commits found in upstream"
            echo "has_new_commits=true" >> $GITHUB_OUTPUT

            # Get count of new commits
            NEW_COMMITS=$(git rev-list --count $MERGE_BASE..$UPSTREAM_HEAD)
            echo "new_commits_count=$NEW_COMMITS" >> $GITHUB_OUTPUT

            # Get short summary of changes
            echo "COMMIT_SUMMARY<<EOF" >> $GITHUB_OUTPUT
            git log --oneline --no-decorate $MERGE_BASE..$UPSTREAM_HEAD | head -20 >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create sync branch
        if: steps.check.outputs.has_new_commits == 'true'
        id: create_branch
        run: |
          BRANCH_NAME="sync/upstream-$(date +%Y-%m-%d)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Create and checkout new branch
          git checkout -b "$BRANCH_NAME"

      - name: Merge upstream changes
        if: steps.check.outputs.has_new_commits == 'true'
        id: merge
        run: |
          # Attempt to merge upstream changes
          if git merge upstream/${{ github.event.inputs.upstream_branch || 'master' }} --no-edit; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "Merge successful"
          else
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            echo "Merge conflicts detected"

            # Get list of conflicting files
            echo "CONFLICT_FILES<<EOF" >> $GITHUB_OUTPUT
            git diff --name-only --diff-filter=U >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # Abort the merge
            git merge --abort
          fi

      - name: Push sync branch (if successful)
        if: steps.check.outputs.has_new_commits == 'true' && steps.merge.outputs.merge_status == 'success'
        run: |
          git push origin ${{ steps.create_branch.outputs.branch_name }}

      - name: Create Pull Request (if successful)
        if: steps.check.outputs.has_new_commits == 'true' && steps.merge.outputs.merge_status == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸ”„ Sync with upstream ($(date +%Y-%m-%d))" \
            --body "$(cat <<'EOF'
          ## ðŸ”„ Upstream Sync

          This PR syncs the latest changes from the upstream repository [`xremap/xremap`](https://github.com/xremap/xremap).

          ### ðŸ“Š Summary
          - **New commits**: ${{ steps.check.outputs.new_commits_count }}
          - **Upstream branch**: `${{ github.event.inputs.upstream_branch || 'master' }}`
          - **Merge status**: âœ… Clean merge (no conflicts)

          ### ðŸ“ Commits from upstream

          ```
          ${{ steps.check.outputs.COMMIT_SUMMARY }}
          ```

          ### âœ… Checklist
          - [ ] Review the changes
          - [ ] Run tests locally if needed
          - [ ] Verify compatibility with any custom modifications
          - [ ] Merge when ready

          ---
          ðŸ¤– This PR was automatically created by the upstream sync workflow.
          EOF
          )" \
            --base "${{ github.event.repository.default_branch }}" \
            --head "${{ steps.create_branch.outputs.branch_name }}" \
            --label "upstream-sync"

      - name: Create Issue (if conflicts)
        if: steps.check.outputs.has_new_commits == 'true' && steps.merge.outputs.merge_status == 'conflict'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "âš ï¸ Upstream sync failed - merge conflicts ($(date +%Y-%m-%d))" \
            --body "$(cat <<'EOF'
          ## âš ï¸ Upstream Sync Failed

          The automatic sync with upstream [`xremap/xremap`](https://github.com/xremap/xremap) encountered merge conflicts.

          ### ðŸ“Š Details
          - **New commits**: ${{ steps.check.outputs.new_commits_count }}
          - **Upstream branch**: `${{ github.event.inputs.upstream_branch || 'master' }}`
          - **Status**: âŒ Merge conflicts detected

          ### ðŸ”§ Conflicting Files
          ```
          ${{ steps.merge.outputs.CONFLICT_FILES }}
          ```

          ### ðŸ“ Recent upstream commits
          ```
          ${{ steps.check.outputs.COMMIT_SUMMARY }}
          ```

          ### ðŸ› ï¸ Manual Resolution Required

          To resolve this manually:

          \`\`\`bash
          # Add upstream remote (if not already added)
          git remote add upstream https://github.com/k0kubun/xremap.git

          # Fetch upstream changes
          git fetch upstream master

          # Create a sync branch
          git checkout -b sync/upstream-$(date +%Y-%m-%d)

          # Merge upstream (this will show conflicts)
          git merge upstream/master

          # Resolve conflicts in your editor, then:
          git add .
          git commit -m "Merge upstream changes"

          # Push and create PR
          git push origin sync/upstream-$(date +%Y-%m-%d)
          \`\`\`

          ---
          ðŸ¤– This issue was automatically created by the upstream sync workflow.
          EOF
          )" \
            --label "upstream-sync,needs-resolution"

      - name: Summary
        if: always()
        run: |
          echo "### Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.has_new_commits }}" = "false" ]; then
            echo "âœ… Repository is up to date with upstream" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.merge.outputs.merge_status }}" = "success" ]; then
            echo "âœ… Successfully created PR with ${{ steps.check.outputs.new_commits_count }} new commits from upstream" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.merge.outputs.merge_status }}" = "conflict" ]; then
            echo "âš ï¸ Merge conflicts detected. Created issue for manual resolution." >> $GITHUB_STEP_SUMMARY
          fi
